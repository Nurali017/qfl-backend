# Инцидентный отчет SOTA: сезон 61 (Premier League 2025)

- Дата формирования (UTC): `2026-02-05T21:26:26.041884+00:00`
- Режим: `apply`
- Контур: локальная БД/синк QFL + проверка источника `sota.id`

## 1. Краткое резюме
- На нашей стороне исправлены технические причины порчи данных (клиент SOTA для GET, дедуп событий, безопасная обработка составов).
- Для сезона `61` выполнена ремедиация данных: пересобраны составы для `182/182` матчей.
- Неустранимый остаток: `20` матчей без событий из-за source gap в SOTA (`/em/*-list.json` возвращает `404` или пустой массив).

## 2. Что исправлено на нашей стороне
- Исправлен HTTP-клиент SOTA: GET-запросы больше не падают из-за передачи `json` в `httpx`.
- Усилен дедуп событий в sync-пайплайнах.
- Убрана деградация составов при пустом `amplua` (игрок не переводится в `substitute` без надежного сигнала).
- Автодообогащение из live-позиций после `pre_game_lineup` сделано безопасным (не включается по умолчанию).

## 3. Метрики до/после ремедиации (сезон 61)
- Матчей всего: `182`
- Аномалии стартовых составов `not_11_11`: `170 -> 0`
- Матчи с `zero_starters_any`: `21 -> 0`
- Матчи `exact_11_11`: `12 -> 182`
- Дубли событий по выбранной сигнатуре: `0 -> 0`
- Матчи без событий (`no_events`): `20 -> 20` (внешняя проблема источника)

## 4. Успешные примеры получения данных из SOTA
Ниже примеры матчей, где данные из источника приходят, и мы их успешно используем.

### Пример A: `a521268c-e122-4d11-972c-0239e029ba1f` (2025-03-01, Ордабасы — Актобе, тур 1)
- `/public/v1/games/{id}/pre_game_lineup/` -> `200`
- Составы pre-game: home `24`, away `23`, referee keys `7`
- `/em/{id}-list.json` -> `200`, событий `7`, голов `2`
- `/em/{id}-team-home.json` -> `200`, игроков `23`, с `amplua=11`
- `/em/{id}-team-away.json` -> `200`, игроков `17`, с `amplua=10`
- Локально после ремедиации: starters `11-11`

### Пример B: `5844b6cf-c2f0-44e6-a723-9119624daf0c` (2025-06-14, Туран — Женис, тур 12)
- `/public/v1/games/{id}/pre_game_lineup/` -> `200`
- Составы pre-game: home `30`, away `28`, referee keys `7`
- `/em/{id}-list.json` -> `200`, событий `13`, голов `2`
- `/em/{id}-team-home.json` -> `200`, игроков `15`, с `amplua=11`
- `/em/{id}-team-away.json` -> `200`, игроков `19`, с `amplua=11`
- Локально после ремедиации: starters `11-11`

## 5. Неуспешные примеры (source gap в SOTA)
Это примеры, где локально событий нет, потому что источник не отдает данные.

### Пример C: `d5a85641-450c-44a8-886d-63fca96014e9` (2025-03-01, Тобол — Улытау, тур 1)
- `/em/{id}-list.json` -> `200`, но payload пустой (`[]`)
- Локально: `local_events=0`, счет матча `2:0`

### Пример D: `fb9046af-c339-4045-a572-ad6dbc67992a` (2025-03-02, Туран — Окжетпес, тур 1)
- `/em/{id}-list.json` -> `404`
- Локально: `local_events=0`, счет матча `2:0`

## 6. Подтвержденные проблемы источника (по CSV)
- `em_events_missing`: `20` строк
- `em_team_missing_ids`: `93` строк
- `em_team_missing_amplua`: `43` строки
- `historical_duplicate_desync`: `5` строк

Подробный перечень по game_id и endpoint в файле:  
`/Users/nuralisagyndykuly/qfl/backend/docs/incidents/sota_s61_incident_2026-02-05.csv`

## 7. Шаги воспроизведения для SOTA
Использовать валидный токен `<TOKEN>`.

```bash
curl "https://sota.id/em/d5a85641-450c-44a8-886d-63fca96014e9-list.json?access_token=<TOKEN>"
curl "https://sota.id/em/fb9046af-c339-4045-a572-ad6dbc67992a-list.json?access_token=<TOKEN>"
curl "https://sota.id/em/a521268c-e122-4d11-972c-0239e029ba1f-team-home.json?access_token=<TOKEN>"
curl "https://sota.id/em/a521268c-e122-4d11-972c-0239e029ba1f-team-away.json?access_token=<TOKEN>"
curl "https://sota.id/em/5844b6cf-c2f0-44e6-a723-9119624daf0c-list.json?access_token=<TOKEN>"
```

## 8. Влияние
- Пустые/отсутствующие события в источнике приводят к необратимым локальным пробелам без синтетического backfill.
- Отсутствие `id`/`amplua` в `/em/team` ухудшает качество live-классификации составов.

## 9. Запрос к SOTA
1. Восстановить/предоставить канонические event payload для матчей, где `/em/*-list.json` пустой или `404`.
2. Обеспечить стабильное наличие `id` и `amplua` в `/em/*-team-{home,away}.json`.
3. Подтвердить политику ретенции/редактирования `/em` для исторических матчей.
